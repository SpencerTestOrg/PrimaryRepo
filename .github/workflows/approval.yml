name: Approval Gate

on: 
  issue_comment:
    types: [created]

permissions:
  contents: read

jobs:
  approve-and-dispatch:
    if: > 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/ok-to-test')
    runs-on: ubuntu-latest

    steps:
      - name: Check commenter permissions
        uses: actions/github-script@v8
        id: pr
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });

            const allowed = ["admin", "write", "maintain"].includes(permission.permission);
            if (!allowed) {
              core.setFailed("User is not authorized to approve tests.");
            }

      - name: Get PR Head SHA
        uses: actions/github-script@v8
        id: pr-info
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            core.setOutput("sha", pr.data.head.sha);
            core.setOutput("repo", pr.data.head.repo.full_name);
            core.setOutput("base_ref", pr.data.base.ref);
      
      - name: Dispatch to Sandbox
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: "SpencerTestOrg",
              repo: "HelperRepo",
              event_type: "run-privileged-workflow",
              client_payload: {
                source_repo: "${{ steps.pr-info.outputs.repo }}",
                sha: "${{ steps.pr-info.outputs.sha }}",
                pr_number: context.issue.number
              }
            });
            
      - name: Get main branch SHA for cache
        uses: actions/github-script@v8
        id: main-sha
        with:
          script: |
            const mainBranch = await github.rest.repos.getBranch({
              owner: 'SpencerTestOrg',
              repo: 'PrimaryRepo',
              branch: 'main'
            });
            
            const sha = mainBranch.data.commit.sha;
            core.setOutput('sha', sha);
            core.info(`Main branch SHA: ${sha}`);
            return sha;
      
      - name: Find build workflow run
        uses: actions/github-script@v8
        id: find-run
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const mainSha = '${{ steps.main-sha.outputs.sha }}';

            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: 'SpencerTestOrg',
              repo: 'PrimaryRepo',
              event: 'push',
              status: 'success',
              branch: 'main',
              per_page: 20
            });

            const matchingRun = runs.data.workflow_runs.find(run => run.head_sha === mainSha);

            if (!matchingRun) {
              core.setFailed(`No successful build found for SHA: ${mainSha}`);
              return;
            }

            core.setOutput('run_id', matchingRun.id.toString());
            core.info(`Found workflow run: ${matchingRun.id}`);
            return matchingRun.id;

      - name: Dispatch nginx test
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const mainSha = '${{ steps.main-sha.outputs.sha }}';

            await github.rest.repos.createDispatchEvent({
              owner: 'SpencerTestOrg',
              repo: 'HelperRepo',
              event_type: 'test-with-nginx',
              client_payload: {
                pr_number: context.issue.number,
                pr_sha: '${{ steps.pr-info.outputs.sha }}',
                pr_repo: '${{ steps.pr-info.outputs.repo }}',
                main_sha: mainSha,
                artifact_name: `nginx-image-${mainSha}`,
                workflow_run_id: '${{ steps.find-run.outputs.run_id }}',
                source_repo: 'SpencerTestOrg/PrimaryRepo',
                base_ref: '${{ steps.pr-info.outputs.base_ref }}'
              }
            });

            core.info('âœ… Dispatched nginx test');

