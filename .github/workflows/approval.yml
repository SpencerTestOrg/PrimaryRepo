name: Approval Gate

on: 
  issue_comment:
    types: [created]

permissions:
  contents: read

jobs:
  approve-and-dispatch:
    if: > 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/ok-to-test')
    runs-on: ubuntu-latest

    steps:
      - name: Check commenter permissions
        uses: actions/github-script@v8
        id: pr
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });

            const allowed = ["admin", "write", "maintain"].includes(permission.permission);
            if (!allowed) {
              core.setFailed("User is not authorized to approve tests.");
            }

      - name: Get PR Head SHA
        uses: actions/github-script@v8
        id: pr-info
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            core.setOutput("sha", pr.data.head.sha);
            core.setOutput("repo", pr.data.head.repo.full_name);
      
      - name: Dispatch to Sandbox
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: "SpencerTestOrg",
              repo: "HelperRepo",
              event_type: "run-privileged-workflow",
              client_payload: {
                source_repo: "${{ steps.pr-info.outputs.repo }}",
                sha: "${{ steps.pr-info.outputs.sha }}",
                pr_number: context.issue.number
              }
            });
            
      - name: Dispatch to Sandbox (Cache)
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const mainSha = ${{ steps.main-sha.outputs.result }};
            const cacheKey = `nginx-image-${mainSha}`;

            await github.rest.repos.createDispatchEvent({
              owner: 'SpencerTestOrg',
              repo: 'HelperRepo',
              event_type: 'test-with-nginx',
              client_payload: {
                pr_number: context.issue.number,
                pr_sha: '${{ steps.pr-info.outputs.sha }}',
                pr_repo: '${{ steps.pr-info.outputs.repo }}',
                main_sha: mainSha,
                nginx_cache_key: cacheKey,  // ← Send cache key instead of image URL
                base_ref: '${{ steps.pr-info.outputs.base_ref }}'
              }
            });

            core.info('✅ Dispatched nginx test workflow');
            core.info(`Cache key: ${cacheKey}`);
            core.info(`Main SHA: ${mainSha}`);


